name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect language components
    runs-on: ubuntu-latest
    outputs:
      has_go: ${{ steps.detect-go.outputs.present }}
      has_rust: ${{ steps.detect-rust.outputs.present }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Go modules
        id: detect-go
        shell: bash
        run: |
          if git ls-files '**/go.mod' | grep -q .; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect Cargo manifests
        id: detect-rust
        shell: bash
        run: |
          if git ls-files '**/Cargo.toml' | grep -q .; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

  opa:
    name: OPA policy build & tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up OPA CLI
        uses: open-policy-agent/setup-opa@v1
        with:
          version: latest

      - name: Build OPA bundle
        run: make opa-build

      - name: Run OPA policy tests
        run: make opa-test

  go:
    name: Go lint, test & coverage
    runs-on: ubuntu-latest
    needs:
      - detect
    if: ${{ needs.detect.outputs.has_go == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.work
          check-latest: true

      - name: Compute Go dependency hash
        id: go-deps-hash
        shell: bash
        run: |
          python3 <<'PY'
          import hashlib
          import os
          import subprocess

          result = subprocess.run(
              ['git', 'ls-files', '**/go.sum'],
              check=True,
              capture_output=True,
              text=True,
          )
          paths = [p for p in result.stdout.splitlines() if p]
          if not paths:
              digest = 'none'
          else:
              hasher = hashlib.sha256()
              for rel in sorted(paths):
                  with open(rel, 'rb') as fh:
                      hasher.update(fh.read())
              digest = hasher.hexdigest()

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"hash={digest}\n")
          PY

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ steps.go-deps-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Go fmt (verify)
        working-directory: apps/gateway-api
        run: |
          files=$(find . -name '*.go' -not -path "*/vendor/*")
          if [ -z "$files" ]; then
            exit 0
          fi
          fmt_out=$(gofmt -l $files)
          if [ -n "$fmt_out" ]; then
            echo "Run 'gofmt' on the Go sources:" >&2
            echo "$fmt_out" >&2
            exit 1
          fi

      - name: Verify gateway module path
        working-directory: apps/gateway-api
        run: go list github.com/OSS-AI-Agent-Tool/OSS-AI-Agent-Tool/apps/gateway-api/...

      - name: Go vet
        working-directory: apps/gateway-api
        run: go vet ./...

      - name: Go test with coverage
        working-directory: apps/gateway-api
        run: go test ./... -coverpkg=./... -coverprofile=coverage.out

      - name: Enforce Go coverage minimum
        working-directory: apps/gateway-api
        run: |
          coverage=$(go tool cover -func=coverage.out | awk '/total:/ { gsub("%","",$3); print $3 }')
          echo "Go coverage: ${coverage}%"
          COVERAGE_VALUE="$coverage" python3 <<'PY'
import os
import sys

raw_coverage = os.environ.get('COVERAGE_VALUE')
if raw_coverage is None or raw_coverage.strip() == '':
    print('Coverage value is missing; ensure go tool cover output is parsed correctly.', file=sys.stderr)
    sys.exit(1)

coverage = float(raw_coverage)
threshold = 60.0

if coverage < threshold:
    print(f"Coverage {coverage:.2f}% is below threshold {threshold:.2f}%", file=sys.stderr)
    sys.exit(1)

print(f"Coverage {coverage:.2f}% meets threshold {threshold:.2f}%")
PY

  typescript:
    name: TypeScript lint, test & build (${{ matrix.project.name }})
    runs-on: ubuntu-latest
    services:
      zookeeper:
        image: confluentinc/cp-zookeeper:7.9.4
        ports:
          - 2181:2181
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
      kafka:
        image: confluentinc/cp-kafka:7.9.4
        ports:
          - 9092:9092
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
          KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        options: >-
          --health-cmd="bash -c 'kafka-topics --bootstrap-server localhost:9092 --list'" --health-interval=10s --health-timeout=5s --health-retries=6
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping" --health-interval=10s --health-timeout=5s --health-retries=6
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: orchestrator
            path: services/orchestrator
            node: '20'
            coverage: "npm run test:coverage"
          - name: cli
            path: apps/cli
            node: '20'
            coverage: "npm run test:coverage"
    defaults:
      run:
        working-directory: ${{ matrix.project.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.project.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.project.node }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project.path }}/package-lock.json

      - name: Verify CLI build scripts use supported package manager
        if: matrix.project.name == 'cli'
        run: |
          node -e "const scripts = require('./package.json').scripts || {}; const unsupported = Object.values(scripts).some((value) => /(?:npm|yarn)\s+(?:ci|install)/.test(String(value))); if (unsupported) { console.error('CLI scripts must not invoke npm install/ci or yarn install directly.'); process.exit(1); }"

      - name: Install pnpm for orchestrator builds
        if: matrix.project.name == 'cli'
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm --version

      - name: Start Docker daemon
        if: matrix.project.name == 'orchestrator'
        run: |
          sudo systemctl start docker
          docker info

      - name: Verify broker container images
        if: matrix.project.name == 'orchestrator'
        run: |
          docker manifest inspect confluentinc/cp-zookeeper:7.9.4 >/dev/null
          docker manifest inspect confluentinc/cp-kafka:7.9.4 >/dev/null
          docker manifest inspect rabbitmq:3.13-management >/dev/null

      - name: Install dependencies
        run: npm ci

      - name: Wait for RabbitMQ and Kafka
        if: matrix.project.name == 'orchestrator'
        run: |
          for i in {1..20}; do
            nc -z localhost 5672 && nc -z localhost 9092 && exit 0
            echo "Waiting for RabbitMQ and Kafka to become available..."
            sleep 5
          done
          echo "RabbitMQ or Kafka did not become ready in time" >&2
          exit 1

      - name: Lint (if configured)
        run: npm run lint --if-present

      - name: Type check (tsc)
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit
          else
            echo "tsconfig.json not found, skipping type check"
          fi

      - name: Run tests with coverage
        run: ${{ matrix.project.coverage }}

      - name: Run queue integration tests
        if: matrix.project.name == 'orchestrator'
        env:
          TESTCONTAINERS_RYUK_DISABLED: true
          CI_RABBITMQ_URL: amqp://guest:guest@localhost:5672
          CI_KAFKA_BROKERS: localhost:9092
        run: npm run test -- PlanQueueRuntime.rabbitmq PlanQueueRuntime.kafka

      - name: Run Vault integration tests
        if: matrix.project.name == 'orchestrator'
        env:
          TESTCONTAINERS_RYUK_DISABLED: true
        run: npm run test -- SecretsStore

      - name: Build (if configured)
        if: matrix.project.name != 'cli'
        run: npm run build --if-present

      - name: Build CLI bundle
        if: matrix.project.name == 'cli'
        run: npm run build

  gui-e2e:
    name: GUI Playwright E2E
    runs-on: ubuntu-latest
    needs:
      - typescript
    defaults:
      run:
        working-directory: apps/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/gui/package-lock.json

      - name: Compute Playwright cache key
        id: gui-cache-key
        run: |
          if [ -f package-lock.json ]; then
            hash=$(sha256sum package-lock.json | cut -d' ' -f1)
          else
            hash=none
          fi
          echo "hash=$hash" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.gui-cache-key.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start mock orchestrator
        run: |
          npm run mock:orchestrator &
          MOCK_PID=$!
          echo "MOCK_PID=$MOCK_PID" >> "$GITHUB_ENV"
          npx --yes wait-on http://127.0.0.1:4010/healthz

      - name: Run Playwright tests
        env:
          VITE_ORCHESTRATOR_URL: http://127.0.0.1:4010
          CI: "true"
        run: npm run test:e2e -- --reporter=list --reporter=html

      - name: Stop mock orchestrator
        if: always() && env.MOCK_PID != ''
        run: kill ${{ env.MOCK_PID }} || true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gui-playwright-report
          path: apps/gui/playwright-report
          retention-days: 5

  rust:
    name: Rust fmt, lint & coverage
    runs-on: ubuntu-latest
    needs:
      - detect
    if: ${{ needs.detect.outputs.has_rust == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libgtk-3-dev \
            libglib2.0-dev \
            libatk1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libsoup-3.0-dev \
            libappindicator3-dev
          if ! sudo apt-get install -y libwebkit2gtk-4.1-dev; then
            sudo apt-get install -y libwebkit2gtk-4.0-dev
          fi

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy rustfmt

      - name: Compute Cargo dependency hash
        id: cargo-lock-hash
        shell: bash
        run: |
          python3 <<'PY'
          import hashlib
          import os
          import subprocess

          result = subprocess.run(
              ['git', 'ls-files', '**/Cargo.lock'],
              check=True,
              capture_output=True,
              text=True,
          )
          paths = [p for p in result.stdout.splitlines() if p]
          if not paths:
              digest = 'none'
          else:
              hasher = hashlib.sha256()
              for rel in sorted(paths):
                  with open(rel, 'rb') as fh:
                      hasher.update(fh.read())
              digest = hasher.hexdigest()

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"hash={digest}\n")
          PY

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ steps.cargo-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Install llvm-tools-preview
        run: rustup component add llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Cargo coverage (llvm-cov)
        run: cargo llvm-cov --all-features --fail-under-lines 60

  e2e:
    name: Multi-service E2E
    runs-on: ubuntu-latest
    needs:
      - go
      - typescript
      - rust
    if: ${{ needs.typescript.result == 'success' && (needs.go.result == 'success' || needs.go.result == 'skipped') && (needs.rust.result == 'success' || needs.rust.result == 'skipped') }}
    defaults:
      run:
        working-directory: services/orchestrator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/orchestrator/package-lock.json

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.work
          check-latest: true

      - name: Install dependencies
        run: npm ci

      - name: Run multi-service E2E tests
        env:
          NODE_ENV: test
        run: npm run test:e2e