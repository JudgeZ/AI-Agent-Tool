name: Security Scans

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: write
  id-token: write

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Gitleaks secret scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --no-git --redact
        env:
          GITHUB_TOKEN: ${{ secrets.GITLEAKS_OAIT || secrets.GITHUB_TOKEN }}

  trivy-fs:
    name: Trivy filesystem scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    env:
      TRIVY_CACHE_DIR: ${{ github.workspace }}/.trivy-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Reset Trivy cache
        run: rm -rf "${TRIVY_CACHE_DIR:-$HOME/.cache/trivy}"

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: fs
          format: table
          exit-code: '1'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  trivy-image:
    name: Trivy image scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: gateway-api
            context: apps/gateway-api
            dockerfile: apps/gateway-api/Dockerfile
          - name: orchestrator
            context: services/orchestrator
            dockerfile: services/orchestrator/Dockerfile
          - name: indexer
            context: services/indexer
            dockerfile: services/indexer/Dockerfile
    env:
      TRIVY_CACHE_DIR: ${{ github.workspace }}/.trivy-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Reset Trivy cache
        run: rm -rf "${TRIVY_CACHE_DIR:-$HOME/.cache/trivy}"

      - name: Determine if Dockerfile exists
        id: has_dockerfile
        run: |
          if [ -f "${{ matrix.image.dockerfile }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Skipping image scan for ${{ matrix.image.name }} (Dockerfile missing)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Build image for scanning
        if: steps.has_dockerfile.outputs.exists == 'true'
        run: |
          docker build -t scan-${{ matrix.image.name }}:pr ${{ matrix.image.context }} -f ${{ matrix.image.dockerfile }}

      - name: Scan image with Trivy
        if: steps.has_dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.25.0
        with:
          image-ref: scan-${{ matrix.image.name }}:pr
          format: table
          exit-code: '1'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  trivy-config:
    name: Trivy config scan (Helm)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    env:
      TRIVY_CACHE_DIR: ${{ github.workspace }}/.trivy-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Reset Trivy cache
        run: rm -rf "${TRIVY_CACHE_DIR:-$HOME/.cache/trivy}"

      - name: Scan Helm chart configuration
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: config
          scan-ref: charts/oss-ai-agent-tool
          format: table
          exit-code: '1'

  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

  npm-audit:
    name: npm audit (${{ matrix.project.name }})
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: orchestrator
            path: services/orchestrator
          - name: cli
            path: apps/cli
          - name: gui
            path: apps/gui
    defaults:
      run:
        working-directory: ${{ matrix.project.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project.path }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high

  gosec:
    name: Gosec static analysis
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # Align with the toolchain pinned in go.work so CI installs a released Go version.
          go-version-file: go.work
          check-latest: true

      - name: Cache Go modules for gosec
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-gosec-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-gosec-
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: gosec ./...

  cargo-audit:
    name: Cargo dependency audit
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo registry for audit
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-audit-

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run cargo audit
        run: cargo audit --deny warnings