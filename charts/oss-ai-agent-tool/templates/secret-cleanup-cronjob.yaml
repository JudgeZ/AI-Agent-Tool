{{- if .Values.retention.secrets.purge.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "oss-ai-agent-tool.fullname" . }}-secret-cleanup
  labels:
    {{- include "oss-ai-agent-tool.labels" . | nindent 4 }}
    app.kubernetes.io/component: maintenance
spec:
  schedule: {{ .Values.retention.secrets.purge.schedule | quote }}
  successfulJobsHistoryLimit: {{ .Values.retention.secrets.purge.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ .Values.retention.secrets.purge.failedJobsHistoryLimit | default 5 }}
  concurrencyPolicy: {{ .Values.retention.secrets.purge.concurrencyPolicy | default "Forbid" }}
  startingDeadlineSeconds: {{ .Values.retention.secrets.purge.startingDeadlineSeconds | default 300 }}
  jobTemplate:
    metadata:
      labels:
        {{- include "oss-ai-agent-tool.labels" . | nindent 8 }}
        app.kubernetes.io/component: maintenance
        job-name: secret-cleanup
    spec:
      backoffLimit: {{ .Values.retention.secrets.purge.backoffLimit | default 3 }}
      activeDeadlineSeconds: {{ .Values.retention.secrets.purge.activeDeadlineSeconds | default 1800 }}
      template:
        metadata:
          labels:
            {{- include "oss-ai-agent-tool.labels" . | nindent 12 }}
            app.kubernetes.io/component: maintenance
            job-name: secret-cleanup
          annotations:
            {{- with .Values.retention.secrets.purge.podAnnotations }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
        spec:
          restartPolicy: OnFailure
          {{- if .Values.retention.secrets.purge.serviceAccountName }}
          serviceAccountName: {{ .Values.retention.secrets.purge.serviceAccountName }}
          {{- else if .Values.vault.serviceAccountName }}
          serviceAccountName: {{ .Values.vault.serviceAccountName }}
          {{- else if .Values.orchestrator.serviceAccount.name }}
          serviceAccountName: {{ .Values.orchestrator.serviceAccount.name }}
          {{- end }}
          securityContext:
            {{- toYaml .Values.podSecurityContext | nindent 12 }}
          containers:
            - name: secret-cleaner
              image: "{{ .Values.image.repo }}/orchestrator:{{ .Values.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              securityContext:
                {{- toYaml .Values.containerSecurityContext | nindent 16 }}
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "Starting secret version cleanup job..."

                  {{- if .Values.retention.secrets.purge.dryRun }}
                  echo "Running in DRY RUN mode - no versions will be deleted"
                  {{- end }}

                  node /app/services/orchestrator/scripts/cleanup-secret-versions.js

                  echo "Secret cleanup completed successfully"
              env:
                # Retention settings
                - name: SECRET_RETENTION_VERSIONS
                  value: {{ .Values.retention.secrets.retentionVersions | default "5" | quote }}

                {{- if .Values.retention.secrets.retentionDays }}
                - name: SECRET_RETENTION_DAYS
                  value: {{ .Values.retention.secrets.retentionDays | quote }}
                {{- end }}

                - name: DRY_RUN
                  value: {{ .Values.retention.secrets.purge.dryRun | default "false" | quote }}

                # Vault configuration (if using Vault as secrets store)
                {{- if .Values.vault.enabled }}
                - name: VAULT_ENABLED
                  value: "true"
                - name: VAULT_ADDR
                  value: {{ .Values.vault.address | quote }}
                - name: VAULT_AUTH_METHOD
                  value: {{ .Values.vault.authMethod | quote }}
                {{- if eq .Values.vault.authMethod "kubernetes" }}
                - name: VAULT_ROLE
                  value: {{ .Values.vault.role | quote }}
                {{- end }}
                {{- if .Values.vault.namespace }}
                - name: VAULT_NAMESPACE
                  value: {{ .Values.vault.namespace | quote }}
                {{- end }}
                {{- if .Values.vault.mountPath }}
                - name: VAULT_MOUNT_PATH
                  value: {{ .Values.vault.mountPath | default "secret" | quote }}
                {{- end }}
                {{- if .Values.vault.keyPrefix }}
                - name: VAULT_KEY_PREFIX
                  value: {{ .Values.vault.keyPrefix | default "oss-ai-agent-tool/" | quote }}
                {{- end }}
                {{- end }}

                # Database configuration (if using Postgres as secrets store)
                {{- if and .Values.postgres.enabled (not .Values.vault.enabled) }}
                - name: DATABASE_URL
                  {{- if .Values.postgres.urlSecretName }}
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.postgres.urlSecretName }}
                      key: {{ .Values.postgres.urlSecretKey | default "url" }}
                  {{- else if .Values.postgres.url }}
                  value: {{ .Values.postgres.url | quote }}
                  {{- else }}
                  value: "postgresql://{{ .Values.postgres.username }}:{{ .Values.postgres.password }}@{{ include "oss-ai-agent-tool.fullname" . }}-postgres:5432/{{ .Values.postgres.database }}"
                  {{- end }}
                {{- end }}

                # Local secrets (if using file-based store)
                {{- if not .Values.vault.enabled }}
                - name: LOCAL_SECRETS_PATH
                  value: {{ .Values.orchestrator.env.LOCAL_SECRETS_PATH | default "/app/config/secrets/local/secrets.json" | quote }}
                {{- end }}

                # Metrics and audit
                - name: METRICS_ENABLED
                  value: {{ .Values.retention.secrets.purge.metricsEnabled | default "true" | quote }}

                - name: AUDIT_ENABLED
                  value: {{ .Values.retention.secrets.purge.auditEnabled | default "true" | quote }}

                # Additional environment variables
                {{- with .Values.retention.secrets.purge.extraEnv }}
                  {{- toYaml . | nindent 16 }}
                {{- end }}
              {{- if .Values.retention.secrets.purge.resources }}
              resources:
                {{- toYaml .Values.retention.secrets.purge.resources | nindent 16 }}
              {{- end }}
              volumeMounts:
                - name: tmp
                  mountPath: /tmp
                {{- if .Values.vault.enabled }}
                {{- if and (eq .Values.vault.authMethod "kubernetes") .Values.vault.kubernetes.jwtPath }}
                - name: vault-token
                  mountPath: {{ dir .Values.vault.kubernetes.jwtPath }}
                  readOnly: true
                {{- end }}
                {{- end }}
                {{- if not .Values.vault.enabled }}
                - name: local-secrets
                  mountPath: /app/config/secrets/local
                  readOnly: true
                {{- end }}
                {{- with .Values.retention.secrets.purge.extraVolumeMounts }}
                  {{- toYaml . | nindent 16 }}
                {{- end }}
          volumes:
            - name: tmp
              emptyDir: {}
            {{- if .Values.vault.enabled }}
            {{- if and (eq .Values.vault.authMethod "kubernetes") .Values.vault.kubernetes.jwtPath }}
            - name: vault-token
              projected:
                sources:
                  - serviceAccountToken:
                      path: {{ base .Values.vault.kubernetes.jwtPath }}
                      expirationSeconds: 3600
            {{- end }}
            {{- end }}
            {{- if not .Values.vault.enabled }}
            - name: local-secrets
              secret:
                secretName: {{ include "oss-ai-agent-tool.fullname" . }}-local-secrets
                optional: true
            {{- end }}
            {{- with .Values.retention.secrets.purge.extraVolumes }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with .Values.retention.secrets.purge.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.retention.secrets.purge.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.retention.secrets.purge.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
