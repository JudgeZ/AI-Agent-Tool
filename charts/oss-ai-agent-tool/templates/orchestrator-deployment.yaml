{{- $root := . -}}
{{- $fullname := include "oss-ai-agent-tool.fullname" $root -}}
{{- $postgresValues := default (dict) $root.Values.postgres -}}
{{- $postgresUser := $postgresValues.username | default "ossaat" -}}
{{- $postgresDatabase := $postgresValues.database | default "ossaat" -}}
{{- $postgresUrlSecretName := $postgresValues.urlSecretName | default "" -}}
{{- $postgresUrlSecretKey := $postgresValues.urlSecretKey | default "url" -}}
{{- $postgresUrlValue := $postgresValues.url | default "" -}}
{{- $explicitPostgresPassword := $postgresValues.password | default "" -}}
{{- $usingBundledPostgres := and ($postgresValues.enabled | default true) (eq $postgresUrlSecretName "") (eq $postgresUrlValue "") -}}
{{- $postgresPasswordValue := ternary "ossaat" $explicitPostgresPassword (and $usingBundledPostgres (eq $explicitPostgresPassword "")) -}}
{{- $defaultOrchestratorEnv := dict }}
{{- $orchestratorValueFromEnv := dict }}
{{- $kafkaRuntime := dict }}
{{- $messagingType := $root.Values.messaging.type | default "rabbitmq" -}}
{{- $mtlsValues := $root.Values.mtls | default dict -}}
{{- $mtlsEnabled := $mtlsValues.enabled | default false -}}
{{- $orchestratorTlsValues := $root.Values.orchestrator.tls | default dict -}}
{{- $orchestratorTlsEnabled := or ($orchestratorTlsValues.enabled | default false) $mtlsEnabled -}}
{{- $orchestratorTlsSecretName := include "oss-ai-agent-tool.orchestratorTlsSecretName" $root -}}
{{- if $orchestratorTlsEnabled -}}
  {{- if not $orchestratorTlsSecretName -}}
    {{- fail "orchestrator.tls.secretName must be provided when TLS is enabled. Set orchestrator.tls.secretName explicitly or enable mtls." -}}
  {{- end -}}
{{- end -}}
{{- $orchestratorTlsMountPath := $orchestratorTlsValues.mountPath | default "/etc/orchestrator/tls" -}}
{{- $orchestratorTlsCertFile := $orchestratorTlsValues.certFile | default "tls.crt" -}}
{{- $orchestratorTlsKeyFile := $orchestratorTlsValues.keyFile | default "tls.key" -}}
{{- $orchestratorTlsCaFile := $orchestratorTlsValues.caFile | default (ternary "ca.crt" "" $mtlsEnabled) -}}
{{- $orchestratorRequestClientCert := true -}}
{{- if hasKey $orchestratorTlsValues "requestClientCert" -}}
  {{- $orchestratorRequestClientCert = $orchestratorTlsValues.requestClientCert -}}
{{- end -}}
{{- $_ := set $defaultOrchestratorEnv "RUN_MODE" ($root.Values.runMode | default "consumer") -}}
{{- $_ := set $defaultOrchestratorEnv "MESSAGING_TYPE" $messagingType -}}
{{- $_ := set $defaultOrchestratorEnv "MESSAGE_BUS" $messagingType -}}
{{- $_ := set $defaultOrchestratorEnv "REDIS_URL" (printf "redis://%s-redis:6379/0" $fullname) -}}
{{- if $postgresUrlSecretName -}}
  {{- $_ := set $orchestratorValueFromEnv "POSTGRES_URL" (dict "secretName" $postgresUrlSecretName "secretKey" $postgresUrlSecretKey) -}}
{{- else if $postgresUrlValue -}}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_URL" (printf "%v" $postgresUrlValue) -}}
{{- else -}}
  {{- if not $postgresPasswordValue -}}
    {{- fail "postgres.password (or postgres.url / postgres.urlSecretName) must be provided when not using the bundled Postgres instance" -}}
  {{- end -}}
  {{- $postgresHost := printf "%s-postgres" $fullname -}}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_URL" (printf "postgres://%s:%s@%s:5432/%s" $postgresUser $postgresPasswordValue $postgresHost $postgresDatabase) -}}
{{- end -}}
{{- if eq $messagingType "rabbitmq" -}}
  {{- $rabbit := default (dict) $root.Values.rabbitmq -}}
  {{- $rabbitUrlSecretName := $rabbit.urlSecretName | default "" -}}
  {{- $rabbitUrl := $rabbit.url | default "" -}}
  {{- $rabbitEnabled := $rabbit.enabled | default true -}}
  {{- $explicitRabbitUser := $rabbit.username | default "" -}}
  {{- $explicitRabbitPassword := $rabbit.password | default "" -}}
  {{- $usingBundledRabbit := and $rabbitEnabled (eq $rabbitUrlSecretName "") (eq $rabbitUrl "") -}}
  {{- $rabbitUser := ternary "guest" $explicitRabbitUser (and $usingBundledRabbit (eq $explicitRabbitUser "")) -}}
  {{- $rabbitPassword := ternary "guest" $explicitRabbitPassword (and $usingBundledRabbit (eq $explicitRabbitPassword "")) -}}
  {{- if $rabbitUrlSecretName -}}
    {{- $_ := set $orchestratorValueFromEnv "RABBITMQ_URL" (dict "secretName" $rabbitUrlSecretName "secretKey" ($rabbit.urlSecretKey | default "url")) -}}
  {{- else if $rabbitUrl -}}
    {{- $_ := set $defaultOrchestratorEnv "RABBITMQ_URL" $rabbitUrl -}}
  {{- else -}}
    {{- if not $rabbitUser -}}
      {{- fail "rabbitmq.username must be provided when rabbitmq.url is unset and the bundled RabbitMQ is disabled" -}}
    {{- end -}}
    {{- if not $rabbitPassword -}}
      {{- fail "rabbitmq.password must be provided when rabbitmq.url is unset and the bundled RabbitMQ is disabled" -}}
    {{- end -}}
    {{- $rabbitHost := $rabbit.host | default (printf "%s-rabbitmq" $fullname) -}}
    {{- $rabbitPort := $rabbit.port | default 5672 -}}
    {{- $rabbitScheme := $rabbit.scheme | default "amqp" -}}
    {{- $rabbitVhost := $rabbit.vhost | default "" -}}
    {{- $vhostSegment := ternary (printf "/%s" ($rabbitVhost | urlquery)) "" (ne $rabbitVhost "") -}}
    {{- $rabbitUrlBuilt := printf "%s://%s:%s@%s:%v%s" $rabbitScheme $rabbitUser $rabbitPassword $rabbitHost $rabbitPort $vhostSegment -}}
    {{- $_ := set $defaultOrchestratorEnv "RABBITMQ_URL" $rabbitUrlBuilt -}}
  {{- end -}}
{{- end -}}
{{- if eq $messagingType "kafka" -}}
  {{- $kafkaCfg := default (dict) $root.Values.messaging.kafka -}}
  {{- $defaultBroker := printf "%s-kafka:9092" $fullname -}}
  {{- $brokers := $kafkaCfg.brokers | default (list $defaultBroker) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_BROKERS" (join "," $brokers) -}}
  {{- if $kafkaCfg.clientId }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_CLIENT_ID" (printf "%v" $kafkaCfg.clientId) -}}
  {{- end -}}
  {{- $consumerGroup := $kafkaCfg.consumerGroup | default $kafkaCfg.groupId -}}
  {{- if $consumerGroup }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_GROUP_ID" (printf "%v" $consumerGroup) -}}
  {{- end -}}
  {{- if hasKey $kafkaCfg "consumeFromBeginning" -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_CONSUME_FROM_BEGINNING" (ternary "true" "false" ($kafkaCfg.consumeFromBeginning | default false)) -}}
  {{- end -}}
  {{- if $kafkaCfg.retryDelayMs }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_RETRY_DELAY_MS" (printf "%v" $kafkaCfg.retryDelayMs) -}}
  {{- end -}}
  {{- if hasKey $kafkaCfg "ensureTopics" -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_ENSURE_TOPICS" (ternary "true" "false" ($kafkaCfg.ensureTopics | default true)) -}}
  {{- end -}}
  {{- if $kafkaCfg.topicPartitions -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_PARTITIONS" (printf "%v" $kafkaCfg.topicPartitions) -}}
  {{- end -}}
  {{- if $kafkaCfg.replicationFactor -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_REPLICATION_FACTOR" (printf "%v" $kafkaCfg.replicationFactor) -}}
  {{- end -}}
  {{- if $kafkaCfg.topicDefaultConfig -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_DEFAULT_CONFIG" (printf "%v" $kafkaCfg.topicDefaultConfig) -}}
  {{- end -}}
  {{- $compactPatterns := $kafkaCfg.compactTopics | default (list) -}}
  {{- if gt (len $compactPatterns) 0 -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_COMPACT_PATTERNS" (join "," $compactPatterns) -}}
  {{- end -}}
  {{- $topics := $kafkaCfg.topics | default (dict) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_PLAN_STEPS" (printf "%v" ($topics.planSteps | default "plan.steps")) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_PLAN_COMPLETIONS" (printf "%v" ($topics.planCompletions | default "plan.completions")) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_PLAN_EVENTS" (printf "%v" ($topics.planEvents | default "plan.events")) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_PLAN_STATE" (printf "%v" ($topics.planState | default "plan.state")) -}}
  {{- $deadLetterSuffix := $topics.deadLetterSuffix | default ".dead" -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_TOPIC_DEAD_LETTER_SUFFIX" (printf "%v" $deadLetterSuffix) -}}
  {{- $_ := set $defaultOrchestratorEnv "KAFKA_DEAD_LETTER_SUFFIX" (printf "%v" $deadLetterSuffix) -}}
  {{- $tlsCfg := $kafkaCfg.tls | default (dict) -}}
  {{- $tlsSecretName := $tlsCfg.secretName | default "" -}}
  {{- $tlsMountPath := $tlsCfg.mountPath | default "/etc/kafka/tls" -}}
  {{- $tlsCaFile := $tlsCfg.caFile | default "ca.crt" -}}
  {{- $tlsCertFile := $tlsCfg.certFile | default "tls.crt" -}}
  {{- $tlsKeyFile := $tlsCfg.keyFile | default "tls.key" -}}
  {{- $certPathValue := $tlsCfg.certPath -}}
  {{- if and (or (eq $certPathValue nil) (eq $certPathValue "")) $tlsSecretName -}}
    {{- $certPathValue = printf "%s/%s" $tlsMountPath $tlsCertFile -}}
  {{- end -}}
  {{- $keyPathValue := $tlsCfg.keyPath -}}
  {{- if and (or (eq $keyPathValue nil) (eq $keyPathValue "")) $tlsSecretName -}}
    {{- $keyPathValue = printf "%s/%s" $tlsMountPath $tlsKeyFile -}}
  {{- end -}}
  {{- $caPathsValue := "" -}}
  {{- if $tlsCfg.caPaths }}
    {{- $caPathsValue = join "," $tlsCfg.caPaths -}}
  {{- else if $tlsSecretName -}}
    {{- $caPathsValue = printf "%s/%s" $tlsMountPath $tlsCaFile -}}
  {{- end -}}
  {{- if $tlsCfg.enabled }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TLS_ENABLED" "true" -}}
    {{- if $caPathsValue }}
      {{- $_ := set $defaultOrchestratorEnv "KAFKA_TLS_CA_PATHS" $caPathsValue -}}
    {{- end -}}
    {{- if $certPathValue }}
      {{- $_ := set $defaultOrchestratorEnv "KAFKA_TLS_CERT_PATH" $certPathValue -}}
    {{- end -}}
    {{- if $keyPathValue }}
      {{- $_ := set $defaultOrchestratorEnv "KAFKA_TLS_KEY_PATH" $keyPathValue -}}
    {{- end -}}
    {{- $rejectUnauthorized := $tlsCfg.rejectUnauthorized | default true -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_TLS_REJECT_UNAUTHORIZED" (ternary "true" "false" $rejectUnauthorized) -}}
  {{- end -}}
  {{- $_ := set $kafkaRuntime "tlsSecretName" $tlsSecretName -}}
  {{- $_ := set $kafkaRuntime "tlsMountPath" $tlsMountPath -}}
  {{- $_ := set $kafkaRuntime "tlsEnabled" ($tlsCfg.enabled | default false) -}}
  {{- $saslCfg := $kafkaCfg.sasl | default (dict) -}}
  {{- if $saslCfg.mechanism }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_SASL_MECHANISM" (printf "%v" $saslCfg.mechanism) -}}
  {{- end -}}
  {{- if $saslCfg.username }}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_SASL_USERNAME" (printf "%v" $saslCfg.username) -}}
  {{- end -}}
  {{- if $saslCfg.passwordSecretName -}}
    {{- $_ := set $orchestratorValueFromEnv "KAFKA_SASL_PASSWORD" (dict "secretName" $saslCfg.passwordSecretName "secretKey" ($saslCfg.passwordSecretKey | default "password")) -}}
  {{- else if $saslCfg.password -}}
    {{- $_ := set $defaultOrchestratorEnv "KAFKA_SASL_PASSWORD" (printf "%v" $saslCfg.password) -}}
  {{- end -}}
{{- end -}}
{{- $langfuseValues := default (dict) $root.Values.langfuse -}}
{{- $langfuseOrchestrator := default (dict) $langfuseValues.orchestrator -}}
{{- $langfuseBaseUrl := $langfuseOrchestrator.baseUrl | default "" -}}
{{- if $langfuseBaseUrl -}}
  {{- $_ := set $defaultOrchestratorEnv "LANGFUSE_BASE_URL" (printf "%v" $langfuseBaseUrl) -}}
{{- else if ($langfuseValues.enabled | default false) -}}
  {{- $_ := set $defaultOrchestratorEnv "LANGFUSE_BASE_URL" (printf "http://%s-langfuse:3000" $fullname) -}}
{{- end -}}
{{- if $langfuseOrchestrator.publicKeySecretName -}}
  {{- $_ := set $orchestratorValueFromEnv "LANGFUSE_PUBLIC_KEY" (dict "secretName" $langfuseOrchestrator.publicKeySecretName "secretKey" ($langfuseOrchestrator.publicKeySecretKey | default "public-key")) -}}
{{- else if $langfuseOrchestrator.publicKey -}}
  {{- $_ := set $defaultOrchestratorEnv "LANGFUSE_PUBLIC_KEY" (printf "%v" $langfuseOrchestrator.publicKey) -}}
{{- end -}}
{{- if $langfuseOrchestrator.secretKeySecretName -}}
  {{- $_ := set $orchestratorValueFromEnv "LANGFUSE_SECRET_KEY" (dict "secretName" $langfuseOrchestrator.secretKeySecretName "secretKey" ($langfuseOrchestrator.secretKeySecretKey | default "secret-key")) -}}
{{- else if $langfuseOrchestrator.secretKey -}}
  {{- $_ := set $defaultOrchestratorEnv "LANGFUSE_SECRET_KEY" (printf "%v" $langfuseOrchestrator.secretKey) -}}
{{- end -}}
{{- $localSecretsConfig := default (dict) $root.Values.orchestrator.localSecrets -}}
{{- if $localSecretsConfig.passphraseSecretName -}}
  {{- $_ := set $orchestratorValueFromEnv "LOCAL_SECRETS_PASSPHRASE" (dict "secretName" $localSecretsConfig.passphraseSecretName "secretKey" ($localSecretsConfig.passphraseSecretKey | default "passphrase")) -}}
{{- else if $localSecretsConfig.passphrase -}}
  {{- $_ := set $defaultOrchestratorEnv "LOCAL_SECRETS_PASSPHRASE" (printf "%v" $localSecretsConfig.passphrase) -}}
{{- end -}}
{{- $policyCacheConfig := default (dict) $root.Values.orchestrator.policy.cache -}}
{{- $policyCacheEnabled := $policyCacheConfig.enabled | default false -}}
{{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_ENABLED" (ternary "true" "false" $policyCacheEnabled) -}}
{{- if hasKey $policyCacheConfig "provider" -}}
  {{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_PROVIDER" (printf "%v" ($policyCacheConfig.provider | default "memory")) -}}
{{- end -}}
{{- if $policyCacheConfig.ttlSeconds -}}
  {{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_TTL_SECONDS" (printf "%v" $policyCacheConfig.ttlSeconds) -}}
{{- end -}}
{{- if $policyCacheConfig.maxEntries -}}
  {{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_MAX_ENTRIES" (printf "%v" $policyCacheConfig.maxEntries) -}}
{{- end -}}
{{- $policyCacheRedis := default (dict) $policyCacheConfig.redis -}}
{{- if and $policyCacheEnabled (eq ($policyCacheConfig.provider | default "memory") "redis") -}}
  {{- $policyRedisUrl := $policyCacheRedis.url | default "" -}}
  {{- if $policyRedisUrl -}}
    {{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_REDIS_URL" (printf "%v" $policyRedisUrl) -}}
  {{- end -}}
  {{- $policyRedisKeyPrefix := $policyCacheRedis.keyPrefix | default "" -}}
  {{- if $policyRedisKeyPrefix -}}
    {{- $_ := set $defaultOrchestratorEnv "POLICY_CACHE_REDIS_KEY_PREFIX" (printf "%v" $policyRedisKeyPrefix) -}}
  {{- end -}}
{{- end -}}
{{- $orchestratorTracing := $root.Values.orchestrator.tracing | default dict -}}
{{- $defaultTracingEndpoint := printf "http://%s-jaeger:4317" $fullname -}}
{{- $tracingEndpoint := $orchestratorTracing.endpoint | default $defaultTracingEndpoint -}}
{{- $_ := set $defaultOrchestratorEnv "OTEL_EXPORTER_OTLP_ENDPOINT" $tracingEndpoint -}}
{{- $_ := set $defaultOrchestratorEnv "TRACING_OTLP_ENDPOINT" $tracingEndpoint -}}
{{- if hasKey $orchestratorTracing "enabled" -}}
  {{- $_ := set $defaultOrchestratorEnv "TRACING_ENABLED" (ternary "true" "false" ($orchestratorTracing.enabled | default true)) -}}
{{- end -}}
{{- if $orchestratorTracing.sampleRatio }}
  {{- $_ := set $defaultOrchestratorEnv "TRACING_SAMPLE_RATIO" (printf "%v" $orchestratorTracing.sampleRatio) -}}
{{- end -}}
{{- if $orchestratorTracing.environment }}
  {{- $_ := set $defaultOrchestratorEnv "TRACING_ENVIRONMENT" (printf "%v" $orchestratorTracing.environment) -}}
{{- end -}}
{{- if $orchestratorTracing.serviceName }}
  {{- $_ := set $defaultOrchestratorEnv "TRACING_SERVICE_NAME" (printf "%v" $orchestratorTracing.serviceName) -}}
  {{- $_ := set $defaultOrchestratorEnv "OTEL_SERVICE_NAME" (printf "%v" $orchestratorTracing.serviceName) -}}
{{- else -}}
  {{- $_ := set $defaultOrchestratorEnv "OTEL_SERVICE_NAME" "oss-ai-orchestrator" -}}
{{- end -}}
{{- if $orchestratorTracing.headers }}
  {{- $headersList := list -}}
  {{- range $key, $value := $orchestratorTracing.headers }}
    {{- $headersList = append $headersList (printf "%s=%s" $key $value) -}}
  {{- end -}}
  {{- if gt (len $headersList) 0 -}}
    {{- $_ := set $defaultOrchestratorEnv "TRACING_OTLP_HEADERS" (join "," $headersList) -}}
  {{- end -}}
{{- end -}}
{{- $_ := set $defaultOrchestratorEnv "SSE_MAX_CONNECTIONS_PER_IP" (printf "%v" ($root.Values.orchestrator.sseQuotas.maxConnectionsPerIP | default 4)) -}}
{{- $_ := set $defaultOrchestratorEnv "SSE_MAX_CONNECTIONS_PER_SUBJECT" (printf "%v" ($root.Values.orchestrator.sseQuotas.maxConnectionsPerSubject | default 2)) -}}
{{- $rateLimitsValues := $root.Values.orchestrator.rateLimits | default dict -}}
{{- $rateLimitBackendValues := $rateLimitsValues.backend | default dict -}}
{{- $rateLimitProvider := $rateLimitBackendValues.provider | default "memory" -}}
{{- $_ := set $defaultOrchestratorEnv "ORCHESTRATOR_RATE_LIMIT_BACKEND" $rateLimitProvider -}}
{{- if eq $rateLimitProvider "redis" -}}
  {{- $redisUrl := $rateLimitBackendValues.redis.url | default (printf "redis://%s-redis:6379/0" $fullname) -}}
  {{- $_ := set $defaultOrchestratorEnv "ORCHESTRATOR_RATE_LIMIT_REDIS_URL" $redisUrl -}}
{{- end -}}
{{- with $rateLimitsValues.plan -}}
  {{- if .windowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_PLAN_WINDOW_MS" (printf "%v" .windowMs) -}}
  {{- end -}}
  {{- if .maxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_PLAN_MAX_REQUESTS" (printf "%v" .maxRequests) -}}
  {{- end -}}
  {{- if .identityWindowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_PLAN_IDENTITY_WINDOW_MS" (printf "%v" .identityWindowMs) -}}
  {{- end -}}
  {{- if .identityMaxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_PLAN_IDENTITY_MAX_REQUESTS" (printf "%v" .identityMaxRequests) -}}
  {{- end -}}
{{- end -}}
{{- with $rateLimitsValues.chat -}}
  {{- if .windowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_CHAT_WINDOW_MS" (printf "%v" .windowMs) -}}
  {{- end -}}
  {{- if .maxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_CHAT_MAX_REQUESTS" (printf "%v" .maxRequests) -}}
  {{- end -}}
  {{- if .identityWindowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_CHAT_IDENTITY_WINDOW_MS" (printf "%v" .identityWindowMs) -}}
  {{- end -}}
  {{- if .identityMaxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_CHAT_IDENTITY_MAX_REQUESTS" (printf "%v" .identityMaxRequests) -}}
  {{- end -}}
{{- end -}}
{{- with $rateLimitsValues.auth -}}
  {{- if .windowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_AUTH_WINDOW_MS" (printf "%v" .windowMs) -}}
  {{- end -}}
  {{- if .maxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_AUTH_MAX_REQUESTS" (printf "%v" .maxRequests) -}}
  {{- end -}}
  {{- if .identityWindowMs -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_AUTH_IDENTITY_WINDOW_MS" (printf "%v" .identityWindowMs) -}}
  {{- end -}}
  {{- if .identityMaxRequests -}}
    {{- $_ := set $defaultOrchestratorEnv "SERVER_RATE_LIMIT_AUTH_IDENTITY_MAX_REQUESTS" (printf "%v" .identityMaxRequests) -}}
  {{- end -}}
{{- end -}}
{{- $requestLimits := $root.Values.orchestrator.requestLimits | default dict -}}
{{- if $requestLimits.jsonBytes }}
  {{- $_ := set $defaultOrchestratorEnv "SERVER_REQUEST_LIMIT_JSON_BYTES" (printf "%v" $requestLimits.jsonBytes) -}}
{{- end -}}
{{- if $requestLimits.urlEncodedBytes }}
  {{- $_ := set $defaultOrchestratorEnv "SERVER_REQUEST_LIMIT_URLENCODED_BYTES" (printf "%v" $requestLimits.urlEncodedBytes) -}}
{{- end -}}
{{- $postgresValues := $root.Values.orchestrator.database.postgres | default dict -}}
{{- if $postgresValues.maxConnections }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_MAX_CONNECTIONS" (printf "%v" $postgresValues.maxConnections) -}}
{{- end -}}
{{- if $postgresValues.minConnections }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_MIN_CONNECTIONS" (printf "%v" $postgresValues.minConnections) -}}
{{- end -}}
{{- if $postgresValues.idleTimeoutMs }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_IDLE_TIMEOUT_MS" (printf "%v" $postgresValues.idleTimeoutMs) -}}
{{- end -}}
{{- if $postgresValues.connectionTimeoutMs }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_CONNECTION_TIMEOUT_MS" (printf "%v" $postgresValues.connectionTimeoutMs) -}}
{{- end -}}
{{- if $postgresValues.maxConnectionLifetimeMs }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_MAX_CONNECTION_LIFETIME_MS" (printf "%v" $postgresValues.maxConnectionLifetimeMs) -}}
{{- end -}}
{{- if $postgresValues.statementTimeoutMs }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_STATEMENT_TIMEOUT_MS" (printf "%v" $postgresValues.statementTimeoutMs) -}}
{{- end -}}
{{- if $postgresValues.queryTimeoutMs }}
  {{- $_ := set $defaultOrchestratorEnv "POSTGRES_QUERY_TIMEOUT_MS" (printf "%v" $postgresValues.queryTimeoutMs) -}}
{{- end -}}
{{- if $root.Values.vault.enabled -}}
  {{- $_ := set $defaultOrchestratorEnv "SECRETS_BACKEND" "vault" -}}
  {{- if $root.Values.vault.address }}
    {{- $_ := set $defaultOrchestratorEnv "VAULT_ADDRESS" (printf "%v" $root.Values.vault.address) -}}
  {{- end -}}
  {{- if $root.Values.vault.namespace }}
    {{- $_ := set $defaultOrchestratorEnv "VAULT_NAMESPACE" (printf "%v" $root.Values.vault.namespace) -}}
  {{- end -}}
  {{- $_ := set $defaultOrchestratorEnv "VAULT_AUTH_METHOD" ($root.Values.vault.authMethod | default "kubernetes") -}}
  {{- if $root.Values.vault.role }}
    {{- $_ := set $defaultOrchestratorEnv "VAULT_ROLE" (printf "%v" $root.Values.vault.role) -}}
  {{- end -}}
  {{- if eq ($root.Values.vault.authMethod | default "kubernetes") "kubernetes" -}}
    {{- if $root.Values.vault.kubernetes.jwtPath }}
      {{- $_ := set $defaultOrchestratorEnv "VAULT_K8S_TOKEN_PATH" (printf "%v" $root.Values.vault.kubernetes.jwtPath) -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- $_ := set $defaultOrchestratorEnv "SECRETS_BACKEND" "localfile" -}}
{{- end -}}
{{- if $root.Values.auth.oidc.enabled -}}
  {{- $oidc := $root.Values.auth.oidc -}}
  {{- $_ := set $defaultOrchestratorEnv "AUTH_OIDC_ENABLED" "true" -}}
  {{- if $oidc.issuer }}
    {{- $_ := set $defaultOrchestratorEnv "OIDC_ISSUER_URL" (printf "%v" $oidc.issuer) -}}
  {{- end -}}
  {{- if $oidc.clientId }}
    {{- $_ := set $defaultOrchestratorEnv "OIDC_CLIENT_ID" (printf "%v" $oidc.clientId) -}}
  {{- end -}}
  {{- if $oidc.redirectBaseUrl }}
    {{- $_ := set $defaultOrchestratorEnv "OAUTH_REDIRECT_BASE" (printf "%v" $oidc.redirectBaseUrl) -}}
  {{- end -}}
  {{- if $oidc.tenantClaim }}
    {{- $_ := set $defaultOrchestratorEnv "OIDC_TENANT_CLAIM" (printf "%v" $oidc.tenantClaim) -}}
  {{- end -}}
  {{- if $oidc.audience }}
    {{- $_ := set $defaultOrchestratorEnv "OIDC_AUDIENCE" (printf "%v" $oidc.audience) -}}
  {{- end -}}
  {{- $scopes := $oidc.scopes | default (list) -}}
  {{- $extraScopes := $oidc.extraScopes | default (list) -}}
  {{- $allScopes := concat $scopes $extraScopes -}}
  {{- if gt (len $allScopes) 0 -}}
    {{- $_ := set $defaultOrchestratorEnv "OIDC_SCOPES" (join " " $allScopes) -}}
  {{- end -}}
{{- end -}}
{{- $orchestratorEnv := merge $defaultOrchestratorEnv ($root.Values.orchestrator.env | default dict) -}}
{{- if and .Values.orchestrator.tls.enabled (not .Values.orchestrator.tls.secretName) -}}
  {{- fail "orchestrator.tls.secretName must be provided when orchestrator.tls.enabled is true" -}}
{{- end -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "oss-ai-agent-tool.fullname" . }}-orchestrator
  labels:
    {{- include "oss-ai-agent-tool.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.orchestrator.replicas | default 1 }}
  selector:
    matchLabels:
      {{- include "oss-ai-agent-tool.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: orchestrator
  template:
    metadata:
      labels:
        {{- include "oss-ai-agent-tool.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: orchestrator
    spec:
      serviceAccountName: {{ include "oss-ai-agent-tool.orchestratorServiceAccountName" . }}
      {{- with .Values.orchestrator.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: orchestrator
          image: {{ include "oss-ai-agent-tool.image" (dict "Values" .Values "Chart" .Chart "component" "orchestrator") }}
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http
              containerPort: {{ .Values.orchestrator.containerPort | default 4000 }}
          env:
            - name: PORT
              value: {{ (.Values.orchestrator.containerPort | default 4000) | quote }}
          {{- range $key, $value := $orchestratorEnv }}
            - name: {{ $key }}
              value: {{ $value | quote }}
          {{- end }}
          {{- range $key, $ref := $orchestratorValueFromEnv }}
            - name: {{ $key }}
              valueFrom:
                secretKeyRef:
                  name: {{ $ref.secretName | quote }}
                  key: {{ ($ref.secretKey | default "password") | quote }}
          {{- end }}
          {{- if and $root.Values.vault.enabled (eq ($root.Values.vault.authMethod | default "kubernetes") "token") $root.Values.vault.tokenSecretName }}
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ $root.Values.vault.tokenSecretName | quote }}
                  key: {{ ($root.Values.vault.tokenSecretKey | default "token") | quote }}
          {{- end }}
          {{- if $orchestratorTlsEnabled }}
            - name: SERVER_TLS_ENABLED
              value: "true"
            - name: SERVER_TLS_CERT_PATH
              value: {{ printf "%s/%s" $orchestratorTlsMountPath $orchestratorTlsCertFile | quote }}
            - name: SERVER_TLS_KEY_PATH
              value: {{ printf "%s/%s" $orchestratorTlsMountPath $orchestratorTlsKeyFile | quote }}
            {{- if $orchestratorTlsCaFile }}
            - name: SERVER_TLS_CA_PATHS
              value: {{ printf "%s/%s" $orchestratorTlsMountPath $orchestratorTlsCaFile | quote }}
            {{- end }}
            - name: SERVER_TLS_REQUEST_CLIENT_CERT
              value: {{ ternary "true" "false" $orchestratorRequestClientCert | quote }}
          {{- end }}
          volumeMounts:
            - name: plan-state
              mountPath: /app/data
          {{- if $orchestratorTlsEnabled }}
            - name: orchestrator-tls
              mountPath: {{ $orchestratorTlsMountPath | quote }}
              readOnly: true
          {{- end }}
          {{- $kafkaTlsSecretName := index $kafkaRuntime "tlsSecretName" -}}
          {{- if $kafkaTlsSecretName }}
            - name: kafka-tls
              mountPath: {{ (index $kafkaRuntime "tlsMountPath" | default "/etc/kafka/tls") | quote }}
              readOnly: true
          {{- end }}
          {{- with .Values.orchestrator.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.orchestrator.containerSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.orchestrator.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.orchestrator.livenessProbe }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
              {{ if $orchestratorTlsEnabled }}
              scheme: HTTPS
              {{ end }}
            initialDelaySeconds: 5
            periodSeconds: 15
          {{- else }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 15
          {{- end }}
          {{- with .Values.orchestrator.readinessProbe }}
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
              {{ if $orchestratorTlsEnabled }}
              scheme: HTTPS
              {{ end }}
            initialDelaySeconds: 2
            periodSeconds: 10
          {{- else }}
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 2
            periodSeconds: 10
          {{- end }}
      volumes:
        - name: plan-state
          emptyDir: {}
      {{- if $orchestratorTlsEnabled }}
        - name: orchestrator-tls
          secret:
            secretName: {{ $orchestratorTlsSecretName | quote }}
      {{- end }}
      {{- $kafkaTlsSecretName := index $kafkaRuntime "tlsSecretName" -}}
      {{- if $kafkaTlsSecretName }}
        - name: kafka-tls
          secret:
            secretName: {{ $kafkaTlsSecretName | quote }}
      {{- end }}
      {{- with .Values.orchestrator.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.orchestrator.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.orchestrator.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
