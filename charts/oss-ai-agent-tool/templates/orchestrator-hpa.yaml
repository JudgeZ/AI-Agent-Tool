{{- $root := . -}}
{{- with $root.Values.orchestrator.hpa }}
{{- if .enabled }}
{{- $messagingType := $root.Values.messaging.type | default "rabbitmq" -}}
{{- $useLagMetric := or (eq $messagingType "kafka") (eq $messagingType "rabbitmq") -}}
{{- $defaultMetric := ternary "orchestrator_queue_lag" "orchestrator_queue_depth" $useLagMetric -}}
{{- $metricName := .metricName | default $defaultMetric -}}
{{- $userMetricSelector := .metricSelector | default dict -}}
{{- $metricSelector := dict -}}
{{- range $key, $value := $userMetricSelector }}
{{- $_ := set $metricSelector $key $value -}}
{{- end -}}
{{- if not (hasKey $metricSelector "queue") -}}
{{- $_ := set $metricSelector "queue" "plan.steps" -}}
{{- end -}}
{{- if and (not (hasKey $metricSelector "transport")) (eq $messagingType "kafka") -}}
{{- $_ := set $metricSelector "transport" "kafka" -}}
{{- else if and (not (hasKey $metricSelector "transport")) (eq $messagingType "rabbitmq") -}}
{{- $_ := set $metricSelector "transport" "rabbitmq" -}}
{{- end -}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "oss-ai-agent-tool.fullname" $root }}-orchestrator
  labels:
    {{- include "oss-ai-agent-tool.labels" $root | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "oss-ai-agent-tool.fullname" $root }}-orchestrator
  minReplicas: {{ .min | default 2 }}
  maxReplicas: {{ .max | default 10 }}
  metrics:
    - type: Pods
      pods:
        metric:
          name: {{ $metricName }}
          {{- if $metricSelector }}
          selector:
            matchLabels:
              {{- range $key, $value := $metricSelector }}
              {{ $key }}: {{ $value | quote }}
              {{- end }}
          {{- end }}
        target:
          type: AverageValue
          averageValue: {{ int (.targetQueueDepth | default 5) }}
{{- end }}
{{- end }}
