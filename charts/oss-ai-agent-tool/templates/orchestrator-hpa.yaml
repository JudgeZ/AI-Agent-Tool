{{- $root := . -}}
{{- with $root.Values.orchestrator.hpa }}
{{- if .enabled }}
{{- $defaultMetric := ternary "orchestrator_queue_lag" "orchestrator_queue_depth" (eq $root.Values.messaging.type "kafka") -}}
{{- $metricName := .metricName | default $defaultMetric -}}
{{- $metricSelector := .metricSelector | default dict -}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "oss-ai-agent-tool.fullname" $root }}-orchestrator
  labels:
    {{- include "oss-ai-agent-tool.labels" $root | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "oss-ai-agent-tool.fullname" $root }}-orchestrator
  minReplicas: {{ .min | default 2 }}
  maxReplicas: {{ .max | default 10 }}
  metrics:
    - type: Pods
      pods:
        metric:
          name: {{ $metricName }}
          {{- if $metricSelector }}
          selector:
            matchLabels:
              {{- range $key, $value := $metricSelector }}
              {{ $key }}: {{ $value | quote }}
              {{- end }}
          {{- end }}
        target:
          type: AverageValue
          averageValue: {{ int (.targetQueueDepth | default 5) }}
{{- end }}
{{- end }}
