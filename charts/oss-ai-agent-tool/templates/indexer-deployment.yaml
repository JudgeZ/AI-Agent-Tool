{{- define "oss-ai-agent-tool.indexerServiceAccountName" -}}
{{- if .Values.indexer.serviceAccount.create -}}
{{- default (printf "%s-indexer" (include "oss-ai-agent-tool.fullname" .)) .Values.indexer.serviceAccount.name -}}
{{- else -}}
{{- default "default" .Values.indexer.serviceAccount.name -}}
{{- end -}}
{{- end -}}
{{- if .Values.indexer.enabled }}
{{- $root := . -}}
{{- $fullname := include "oss-ai-agent-tool.fullname" $root -}}
{{- $defaultIndexerEnv := dict "RUST_LOG" ($root.Values.indexer.logLevel | default "info") -}}
{{- $_ := set $defaultIndexerEnv "INDEXER_MAX_REQUEST_BODY_BYTES" (printf "%v" ($root.Values.indexer.requestLimitBytes | default 1048576)) -}}
{{- $_ := set $defaultIndexerEnv "RUN_MODE" ($root.Values.runMode | default "consumer") -}}
{{- $indexerValueFromEnv := dict -}}
{{- $indexerTracing := $root.Values.indexer.tracing | default dict -}}
{{- $defaultIndexerEndpoint := $indexerTracing.endpoint | default (printf "http://%s-jaeger:4317" $fullname) -}}
{{- $_ := set $defaultIndexerEnv "OTEL_EXPORTER_OTLP_ENDPOINT" $defaultIndexerEndpoint -}}
{{- $_ := set $defaultIndexerEnv "INDEXER_TRACING_ENABLED" (ternary "true" "false" ($indexerTracing.enabled | default true)) -}}
{{- if $indexerTracing.sampleRatio }}
  {{- $_ := set $defaultIndexerEnv "INDEXER_TRACING_SAMPLE_RATIO" (printf "%v" $indexerTracing.sampleRatio) -}}
{{- end -}}
{{- if $indexerTracing.environment }}
  {{- $_ := set $defaultIndexerEnv "INDEXER_TRACING_ENVIRONMENT" (printf "%v" $indexerTracing.environment) -}}
{{- end -}}
{{- if $indexerTracing.headers }}
  {{- $indexerHeaderList := list -}}
  {{- range $key, $value := $indexerTracing.headers }}
    {{- $indexerHeaderList = append $indexerHeaderList (printf "%s=%s" $key $value) -}}
  {{- end -}}
  {{- if gt (len $indexerHeaderList) 0 -}}
    {{- $_ := set $defaultIndexerEnv "OTEL_EXPORTER_OTLP_HEADERS" (join "," $indexerHeaderList) -}}
  {{- end -}}
{{- end -}}
{{- $_ := set $defaultIndexerEnv "OTEL_SERVICE_NAME" ($indexerTracing.serviceName | default "oss-indexer") -}}
{{- $authConfig := $root.Values.indexer.auth | default dict -}}
{{- if $authConfig.disabled | default false }}
  {{- $_ := set $defaultIndexerEnv "INDEXER_AUTH_DISABLED" "1" -}}
{{- else }}
  {{- $jwtConfig := $authConfig.jwt | default dict -}}
  {{- $jwtSecretName := $jwtConfig.secretSecretName | default "" -}}
  {{- $jwtSecretKey := $jwtConfig.secretSecretKey | default "secret" -}}
  {{- $jwtSecretValue := $jwtConfig.secret | default "" -}}
  {{- $defaultJwtSecretName := printf "%s-indexer-jwt" $fullname -}}
  {{- if and (not $jwtSecretName) (not $jwtSecretValue) }}
    {{- $jwtSecretName = $defaultJwtSecretName -}}
  {{- end }}
  {{- if $jwtSecretName }}
    {{- $_ := set $indexerValueFromEnv "INDEXER_JWT_HS256_SECRET" (dict "secretName" $jwtSecretName "secretKey" $jwtSecretKey) -}}
  {{- else if $jwtSecretValue }}
    {{- $_ := set $defaultIndexerEnv "INDEXER_JWT_HS256_SECRET" $jwtSecretValue -}}
  {{- else }}
    {{- fail "indexer.auth.jwt.secretSecretName or indexer.auth.jwt.secret must be provided when indexer authentication is enabled" -}}
  {{- end }}
  {{- $issuer := $jwtConfig.issuer | default (printf "http://%s-orchestrator:4000" $fullname) -}}
  {{- $audience := $jwtConfig.audience | default "oss-ai-indexer" -}}
  {{- $_ := set $defaultIndexerEnv "INDEXER_JWT_ISSUER" $issuer -}}
  {{- $_ := set $defaultIndexerEnv "INDEXER_JWT_AUDIENCE" $audience -}}
{{- end }}
{{- $indexerEnv := merge $defaultIndexerEnv ($root.Values.indexer.env | default dict) -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "oss-ai-agent-tool.fullname" . }}-indexer
  labels:
    {{- include "oss-ai-agent-tool.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.indexer.replicas | default 1 }}
  selector:
    matchLabels:
      {{- include "oss-ai-agent-tool.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: indexer
  template:
    metadata:
      labels:
        {{- include "oss-ai-agent-tool.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: indexer
    spec:
      serviceAccountName: {{ include "oss-ai-agent-tool.indexerServiceAccountName" . }}
      {{- with .Values.indexer.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: indexer
          image: {{ include "oss-ai-agent-tool.image" (dict "Values" .Values "Chart" .Chart "component" "indexer") }}
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http
              containerPort: {{ .Values.indexer.containerPort | default 7070 }}
          env:
          {{- range $key, $value := $indexerEnv }}
            - name: {{ $key }}
              value: {{ $value | quote }}
          {{- end }}
          {{- range $key, $ref := $indexerValueFromEnv }}
            - name: {{ $key }}
              valueFrom:
                secretKeyRef:
                  name: {{ $ref.secretName | quote }}
                  key: {{ ($ref.secretKey | default "secret") | quote }}
          {{- end }}
          {{- with .Values.indexer.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.indexer.containerSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.indexer.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 2
            periodSeconds: 10
      {{- with .Values.indexer.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.indexer.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.indexer.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
